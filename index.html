<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="description" content="This is a mobile machine drum to play with friends in the same room. Admin can control intruments in the peers mobile devices.">
    <meta name="keywords" content="mobile machine drum, mobile, machine, drum, machine drum, play, friend, friends">
    <meta name="author" content="Free Geeks a.k.a. RRR">
	<title>Mobile Machine Drum</title>
    <style>
    /*
     * Add CSS here
     */
     html, body {
     	width: 100%;
     	height: 100%;
     	margin: 0;
     }
     .instrument {
         float: left;
         padding: 50px;
         border: 1px solid #000;
         background: #fff;
         list-style: none;
         margin-top: 60px;
     }
     .instrument:hover {
     	opacity: .6;
     	border: 10px solid #333;
     }
     
     audio {
         display: none;
     }
     h1 {
     	z-index: 100;
     }
     ul { 
         background: url(img/bg.png) no-repeat center top;
         height: 3000px;
         width: 100%;
         position: absolute;
         top: 0;
         left: 0;
         margin: 0;
         z-index: -1;
     }
    </style>
</head>

<body>

    <h1>Mobile Machine Drum</h1>

    <audio src="/coin.wav" controls="controls"></audio> 

    <ul id="instruments">
        <li class="instrument" data-color="red" data-wav="tom"></li>
        <li class="instrument" data-color="orange" data-wav="sn"></li>
        <li class="instrument" data-color="yellow" data-wav="hh2"></li>
        <li class="instrument" data-color="green" data-wav="hh1"></li>
        <li class="instrument" data-color="blue" data-wav="bd"></li>
        <li class="instrument" data-color="indigo" data-wav="bd"></li>
        <li class="instrument" data-color="violet" data-wav="bd"></li>
    </ul>

    <script src="/socket.io/socket.io.js"></script>
    <script>
    /*
     * Add JS here at the bottom of the page
     * to avoid the whole document.ready since
     * we are not using jquery
     */

    // Single DOM element selection
    window.$ = function(selector) {
      return document.querySelector(selector);
    };

    // Multiple DOM element selection
    window.$$ = function(selector) {
        var items   = {};
        var results = Array.prototype.slice.call(document.querySelectorAll(selector));
        var length  = results.length;
        
        for (var i = 0 ; i < length; i++) {
            items[i] = results[i];
        }
        
        items.length = length;
        items.splice = [].splice();
        
        items.each = function(callback) {
            for (var i = 0 ; i < length; i++) {
                callback.call(items[i]);
            }
        }

        items.on = function (event, fn) {
            []['forEach'].call(this, function (el) {
                el.on(event, fn);
            });
            return this;
        };

        return items;
    };

    // Bind event using "on"
    Element.prototype.on = Element.prototype.addEventListener;

    // Start up audio
    var audio = $('audio');
    audio.controls = 'controls';
    audio.load();

    // Once audio finished playing
    audio.on('ended', function () {
        // Change background to WHITE 
        $('body').style.backgroundColor = 'white';
    });

    var socket = io.connect('http://84.33.51.10', 8443);

    // Paint the instruments with its own color
    // and adds the text inside it
    $$('.instrument').each(function () {
        this.style.backgroundColor = this.dataset.color;
        this.innerHTML = this.dataset.wav;
    });

    // Define room name used for all events
    var room    = location.pathname;

    var admin = function () { 

        $('h1').innerHTML = 'Mobile Machine Drum - Admin';

        // New instrument joins
        socket.on(room + '-instrument', function (data) {
            audio.play();
            //$('.instrument[data-wav=' + data.wav + ']').appendChild('<span>.</span>');
        });

        // Once select the instrument
        $$('.instrument').on('click', function () {
            // Send the hit to server
            socket.emit('hit', { room: room, wav: this.dataset.wav });
        });

    };

    var instrument = function () {

        $('h1').innerHTML = 'Mobile Machine Drum - Instrument';

        // Clean event instrument joins
        socket.on(room + '-instrument', function () {});

        // Once select the instrument
        $$('.instrument').on('click', function () {
            var color   = this.dataset.color;
            var wav     = this.dataset.wav;

            // Remove instrument selection
            $('#instruments').parentNode.removeChild($('#instruments'));

            // Load selected audio
            audio.src = 'http://84.33.51.10:8443/' + wav + '.wav';
            audio.load();
            audio.play();
            audio.pause();

            // Inform the server the instrument
            socket.emit('instrument', { room: room, wav: wav });

            // Listen to the HIT
            socket.on(room + '-hit-' + wav , function() {
                
                // Play audio
                audio.currentTime = 0;
                audio.play();

                // Change background to HIT color
                $('body').style.backgroundColor = color;
            });
            
        });

    }

    // Self discovery
    var pongs   = 0;
    var ping    = Math.floor(Math.random()*100000000);
    socket.on('ping', function (data) {
        if (data.room != room) {
            return;
        }
        socket.emit('pong', { id: data.id, room: room });
    });
    socket.on('pong', function (data) {
        if (data.id != ping || data.room != room) {
            return;
        }
        if (++pongs == 1) {
            admin();
        }
        else {
            instrument();
        }
    });
    socket.emit('ping', { id: ping, room: room });
    </script>

</body>

</html>
