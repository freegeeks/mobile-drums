<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="This is a mobile machine drum to play with friends in the same room. Admin can control intruments in the peers mobile devices.">
    <meta name="keywords" content="mobile machine drum, mobile, machine, drum, machine drum, play, friend, friends">
    <meta name="author" content="Free Geeks a.k.a. RRR">
	<title>Mobile Machine Drum</title>
	<link rel="stylesheet" href="css/reset.css" type="text/css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Dosis' rel='stylesheet' type='text/css'>
    <style>
    /*
     * Add CSS here
     */
     html {
     	width: 100%;
     }
     body{
		background: #062d47; /* Old browsers */
		background: -moz-linear-gradient(top,  #062d47 0%, #323333 99%, #323333 99%); /* FF3.6+ */
		background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#062d47), color-stop(99%,#323333), color-stop(99%,#323333)); /* Chrome,Safari4+ */
		background: -webkit-linear-gradient(top,  #062d47 0%,#323333 99%,#323333 99%); /* Chrome10+,Safari5.1+ */
		background: -o-linear-gradient(top,  #062d47 0%,#323333 99%,#323333 99%); /* Opera 11.10+ */
		background: -ms-linear-gradient(top,  #062d47 0%,#323333 99%,#323333 99%); /* IE10+ */
		background: linear-gradient(to bottom,  #062d47 0%,#323333 99%,#323333 99%); /* W3C */
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#062d47', endColorstr='#323333',GradientType=0 ); /* IE6-9 */
		}
		body * {
			font-family: 'Dosis', sans-serif;
			text-shadow: 2px 2px #000;
			
		}
     .instrument {
       float: left;
       padding: 150px;
       height: 150px;
       border: 1px solid #000;
       background: #fff;
       list-style: none;
       border-radius: 30px;
       margin: 15px;
       display: block;
       background: #4162a8;
       border-top: 1px solid #38538c;
       border-right: 1px solid #1f2d4d;
       border-bottom: 1px solid #151e33;
       border-left: 1px solid #1f2d4d;
       -webkit-box-shadow: inset 0 1px 10px 1px #5c8bee, 0px 1px 0 #1d2c4d, 0 6px 0px #1f3053, 0 8px 4px 1px #111111;
       box-shadow: inset 0 1px 10px 1px #5c8bee, 0px 1px 0 #1d2c4d, 0 6px 0px #1f3053, 0 8px 4px 1px #111111;
       color: #fff;
       font: bold 20px/1 "helvetica neue", helvetica, arial, sans-serif;
       margin-bottom: 10px;
       padding: 10px 0 12px 0;
       text-align: center;
       text-shadow: 0px -1px 1px #1e2d4d;
       width: 150px;
       -webkit-background-clip: padding-box;
    }
    
    h1{
    	width: 100%;
    	height: 260px;
    	display: block;
    	text-indent: -9999px;
    	margin: auto;
    	background: url('img/logo.png') no-repeat center top;
    	height: 420px;
    }
       .instrument.hit,
       .instrument:hover {
         -webkit-box-shadow: inset 0 0px 20px 1px #87adff, 0px 1px 0 #1d2c4d, 0 6px 0px #1f3053, 0 8px 4px 1px #111111;
         box-shadow: inset 0 0px 20px 1px #87adff, 0px 1px 0 #1d2c4d, 0 6px 0px #1f3053, 0 8px 4px 1px #111111;
         cursor: pointer; }
       .instrument:active {
         -webkit-box-shadow: inset 0 1px 10px 1px #5c8bee, 0 1px 0 #1d2c4d, 0 2px 0 #1f3053, 0 4px 3px 0 #111111;
         box-shadow: inset 0 1px 10px 1px #5c8bee, 0 1px 0 #1d2c4d, 0 2px 0 #1f3053, 0 4px 3px 0 #111111;
         margin-top: 20px;}
     
     audio {
         display: none;
     }
     h1 {
     	z-index: 100;
     }
     ul { 
         width: 100%;
         float: left;
         display: block;
     }
     p{
     	color: #fff;
     	font-size: 2em;
     	text-align: center;
     	padding: 20px;
     }
     input {
     	background: #0080ab;
     	border-radius: 15px;
     	padding: 15px;
     	color: #fff;
     	font-size: 2em;
     	width: 80%;
     	margin: auto;
     	display: block;
     	border: 1px solid #333;
     }
     a{
     	font-size: 7em;
     	color: #fff;
     	text-decoration: none;
     	text-align: center;
     	width: 100%;
     	float: left;
     	font-weight: bold;
     	margin-bottom: 20px;
     	
     }
     h2 {
     	display: none;
     }
     
     @media (max-width: 500px) {
     
     h1 {
     	background-size: 100%;
     	height: 270px;
     	padding-bottom: 11%;
     }
     
     }
    </style>
</head>
<body>

<h1>Mobile Machine Drum</h1>
<p>play drums using your friend's mobiles!</p>
<audio src="/coin.wav" controls="controls"></audio> 

<ul id="instruments">
    <li class="instrument" data-color="red" data-wav="tom"></li>
    <li class="instrument" data-color="orange" data-wav="sn"></li>
    <li class="instrument" data-color="yellow" data-wav="hh2"></li>
    <li class="instrument" data-color="green" data-wav="hh1"></li>
    <li class="instrument" data-color="blue" data-wav="bd"></li>
    <li class="instrument" data-color="indigo" data-wav="bd"></li>
</ul>

<h2>share</h2>
	
<script src="/socket.io/socket.io.js"></script>
<script>
/*
 * Add JS here at the bottom of the page
 * to avoid the whole document.ready since
 * we are not using jquery
 */

// Single DOM element selection
window.$ = function(selector) {
  return document.querySelector(selector);
};

// Multiple DOM element selection
window.$$ = function(selector) {
    var items   = {};
    var results = Array.prototype.slice.call(document.querySelectorAll(selector));
    var length  = results.length;
    
    for (var i = 0 ; i < length; i++) {
        items[i] = results[i];
    }
    
    items.length = length;
    items.splice = [].splice();
    
    items.each = function(callback) {
        for (var i = 0 ; i < length; i++) {
            callback.call(items[i]);
        }
    }

    items.on = function (event, fn) {
        []['forEach'].call(this, function (el) {
            el.on(event, fn);
        });
        return this;
    };

    return items;
};

// Bind event using "on"
Element.prototype.on = Element.prototype.addEventListener;

var MachineDrums = function() {
    var self = this;

    // Config options
    self.server = {
        hostname: '127.0.0.1',
        port    : 8443
    };
    self.animationTime = 1000; // milliseconds

    // Current wav
    self.wav = null;

    // Get each wav from the drums
    self.waves = {};
    $$('.instrument').each(function() {
        self.waves[this.dataset.wav] = this;

        // Paint the instruments with its own color
        // and adds the text inside it
        $$('.instrument').each(function () {
            this.style.backgroundColor = this.dataset.color;
            this.innerHTML = this.dataset.wav;
        });
    });

    // Handle the socket communication
    var socketHandler = function() {
        // Define room name
        self.room = location.pathname;

        // Connect
        self.socket = io.connect('http://' + self.server.hostname, self.server.port);

        // Join the room
        self.socket.on('connect', function() {
            self.socket.emit('join', self.room);
        });
        self.socket.on('role', function(role) {
            if (role == 'adm') {
                self.roleAsAdmin();
            } else {
                self.roleAsInstrument();
            }
        });
    };
    socketHandler();

    return this;
};

MachineDrums.prototype.roleAsAdmin = function() {
    var self = this;

    // Set as admin and enable controls
    $('h1').innerHTML = 'Mobile Machine Drum - Admin';

    // Once select the instrument
    $$('.instrument').on('click', function () {
        // Send the hit to server
        self.socket.emit('hit', { room: self.room, wav: this.dataset.wav });
    });
};

MachineDrums.prototype.roleAsInstrument = function() {
    var self = this;

    // Set as instrument and disable controls
    $('h1').innerHTML = 'Mobile Machine Drum - Instrument';

    // Once select the instrument
    $$('.instrument').on('click', function() {
        var color = this.dataset.color;
        var wav   = this.dataset.wav;

        // Mark the selected wav
        self.wav = wav;

        // Load selected audio
        self.audio = $('audio');
        self.audio.controls = 'controls';
        self.audio.src = 'http://' + self.server.hostname + ':' + self.server.port + '/' + wav + '.wav';
        self.audio.load();
        self.audio.play();
        self.audio.pause();

        // Once audio finished playing
        self.audio.on('ended', function () {
            // Do something?
        });

        // Inform the server the instrument
        self.socket.emit('instrument', { room: self.room, wav: wav });

        // Listen to the HIT
        self.socket.on('hit', function(wav) {
           self.onHit(wav);
        });
    });
};

MachineDrums.prototype.onHit = function(wav) {
    var self = this;

    // Get instrument element
    var el = self.waves[wav];

    // Only play audio if selected wav
    if (self.wav === wav) {
        self.audio.currentTime = 0;
        self.audio.play();
    }
    el.className = 'instrument hit';

    window.setTimeout(function() {
        el.className = 'instrument';
    }, self.animationTime);
};

var instance = new MachineDrums();

</script>

</body>
</html>
